<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线测试 - Sora2API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slide-up{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
        .animate-slide-up{animation:slide-up .3s ease-out}
        .tab-btn{transition:all .2s ease}
        .aspect-video{aspect-ratio:16/9}
        .aspect-portrait{aspect-ratio:9/16}
        .aspect-square{aspect-ratio:1/1}
    </style>
    <script>
        tailwind.config={theme:{extend:{colors:{border:"hsl(0 0% 89%)",input:"hsl(0 0% 89%)",ring:"hsl(0 0% 3.9%)",background:"hsl(0 0% 100%)",foreground:"hsl(0 0% 3.9%)",primary:{DEFAULT:"hsl(0 0% 9%)",foreground:"hsl(0 0% 98%)"},secondary:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 9%)"},muted:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 45.1%)"},destructive:{DEFAULT:"hsl(0 84.2% 60.2%)",foreground:"hsl(0 0% 98%)"}}}}}
    </script>
</head>
<body class="h-full bg-background text-foreground antialiased">
    <!-- 导航栏 -->
    <header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur">
        <div class="mx-auto flex h-14 max-w-7xl items-center px-6">
            <div class="mr-4 flex items-baseline gap-3">
                <a href="manage.html" class="font-bold text-xl hover:opacity-80">Sora2API</a>
            </div>
            <div class="flex flex-1 items-center justify-end gap-3">
                <a href="manage.html" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5" title="管理控制台">
                    <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    管理
                </a>
                <a href="https://github.com/TheSmallHanCat/sora2api" target="_blank" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5" title="GitHub 仓库">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-6">
        <h1 class="text-2xl font-bold mb-6">Sora AI 创作测试</h1>
        
        <!-- Tab 导航 -->
        <div class="border-b border-border mb-6">
            <nav class="flex space-x-8">
                <button onclick="switchTab('video')" id="tabVideo" class="tab-btn border-b-2 border-primary text-sm font-medium py-3 px-1">视频创作</button>
                <button onclick="switchTab('image')" id="tabImage" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">图片创作</button>
            </nav>
        </div>

        <!-- 视频创作面板 -->
        <div id="panelVideo" class="grid gap-6 lg:grid-cols-2">
            <!-- 左侧：配置参数 -->
            <div class="space-y-6">
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">视频配置</h3>
                    <div class="space-y-4">
                        <!-- 创作模式 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">创作模式</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setVideoMode('normal')" id="modeNormal" class="px-3 py-2 text-sm rounded-md border border-primary bg-primary text-primary-foreground">普通生成</button>
                                <button onclick="setVideoMode('remix')" id="modeRemix" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent">视频Remix</button>
                                <button onclick="setVideoMode('storyboard')" id="modeStoryboard" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent">视频分镜</button>
                            </div>
                        </div>

                        <!-- 模型选择 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">模型</label>
                            <select id="videoModel" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                <option value="sora-video">Sora Video</option>
                            </select>
                            <p class="text-xs text-muted-foreground mt-1">OpenAI 视频生成</p>
                        </div>

                        <!-- 画面比例 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">画面比例</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setOrientation('landscape')" id="orientLandscape" class="px-3 py-2 text-sm rounded-md border border-primary bg-primary text-primary-foreground flex items-center justify-center gap-2">
                                    <span class="text-lg">▬</span> 16:9
                                </button>
                                <button onclick="setOrientation('portrait')" id="orientPortrait" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent flex items-center justify-center gap-2">
                                    <span class="text-lg">▮</span> 9:16
                                </button>
                            </div>
                        </div>

                        <!-- 视频时长 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">视频时长</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setDuration('10')" id="dur10" class="px-3 py-2 text-sm rounded-md border border-primary bg-primary text-primary-foreground">10 秒</button>
                                <button onclick="setDuration('15')" id="dur15" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent">15 秒</button>
                                <button onclick="setDuration('25')" id="dur25" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent">25 秒</button>
                            </div>
                        </div>

                        <!-- 视频风格 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">视频风格</label>
                            <select id="videoStyle" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                <option value="">无风格</option>
                                <option value="anime">Anime</option>
                                <option value="comic">Comic</option>
                                <option value="festive">Festive</option>
                                <option value="golden">Golden</option>
                                <option value="handheld">Handheld</option>
                                <option value="news">News</option>
                                <option value="retro">Retro</option>
                                <option value="selfie">Selfie</option>
                                <option value="vintage">Vintage</option>
                            </select>
                            <p class="text-xs text-muted-foreground mt-1">可选：选择一个风格应用到生成的视频</p>
                        </div>

                        <!-- 参考素材 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">参考素材</label>
                            <div id="videoRefUpload" class="border-2 border-dashed border-input rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors" onclick="document.getElementById('videoRefInput').click()">
                                <input type="file" id="videoRefInput" accept="image/*" class="hidden" onchange="handleVideoRefUpload(event)">
                                <div id="videoRefPreview" class="hidden">
                                    <img id="videoRefImg" class="max-h-32 mx-auto rounded" />
                                    <button onclick="clearVideoRef(event)" class="mt-2 text-xs text-destructive hover:underline">移除</button>
                                </div>
                                <div id="videoRefPlaceholder">
                                    <svg class="h-8 w-8 mx-auto text-muted-foreground mb-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <p class="text-sm text-muted-foreground">点击上传图片</p>
                                    <p class="text-xs text-muted-foreground">支持 JPG, PNG</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remix 视频ID (仅Remix模式显示) -->
                        <div id="remixIdSection" class="hidden">
                            <label class="text-sm font-medium mb-2 block">Remix 视频ID</label>
                            <input id="remixTargetId" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="输入 Sora 分享链接中的视频ID (如 s_xxx)">
                            <p class="text-xs text-muted-foreground mt-1">从 Sora 分享链接获取视频ID进行Remix</p>
                        </div>

                        <!-- 提示词 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">提示词</label>
                            <textarea id="videoPrompt" rows="4" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm resize-y" placeholder="描述你想要生成的视频内容..."></textarea>
                        </div>

                        <!-- 生成按钮 -->
                        <button onclick="generateVideo()" id="videoGenBtn" class="w-full inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 text-sm font-medium">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            开始生成
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧：预览区域 -->
            <div class="rounded-lg border border-border bg-background p-6">
                <h3 class="text-lg font-semibold mb-4">生成结果</h3>
                <div id="videoResult" class="space-y-4">
                    <div id="videoPreviewArea" class="aspect-video bg-muted rounded-lg flex items-center justify-center">
                        <p class="text-muted-foreground">等待生成...</p>
                    </div>
                    <div id="videoStatus" class="text-sm text-muted-foreground text-center"></div>
                </div>
            </div>
        </div>

        <!-- 图片创作面板 -->
        <div id="panelImage" class="hidden grid gap-6 lg:grid-cols-2">
            <!-- 左侧：配置参数 -->
            <div class="space-y-6">
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">图片配置</h3>
                    <div class="space-y-4">
                        <!-- 模型选择 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">模型</label>
                            <select id="imageModel" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                <option value="sora-image">Sora Image</option>
                            </select>
                            <p class="text-xs text-muted-foreground mt-1">高质量图像</p>
                        </div>

                        <!-- 画面比例 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">画面比例</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="setImageSize('1024x1024')" id="size1x1" class="px-3 py-2 text-sm rounded-md border border-primary bg-primary text-primary-foreground">1:1</button>
                                <button onclick="setImageSize('1792x1024')" id="size3x2" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent">3:2</button>
                                <button onclick="setImageSize('1024x1792')" id="size2x3" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent">2:3</button>
                                <button onclick="setImageSize('1536x1024')" id="size16x9" class="px-3 py-2 text-sm rounded-md border border-input hover:bg-accent">16:9</button>
                            </div>
                        </div>

                        <!-- 参考图 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">参考图</label>
                            <div id="imageRefUpload" class="border-2 border-dashed border-input rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors" onclick="document.getElementById('imageRefInput').click()">
                                <input type="file" id="imageRefInput" accept="image/*" class="hidden" onchange="handleImageRefUpload(event)">
                                <div id="imageRefPreview" class="hidden">
                                    <img id="imageRefImg" class="max-h-32 mx-auto rounded" />
                                    <button onclick="clearImageRef(event)" class="mt-2 text-xs text-destructive hover:underline">移除</button>
                                </div>
                                <div id="imageRefPlaceholder">
                                    <svg class="h-8 w-8 mx-auto text-muted-foreground mb-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <p class="text-sm text-muted-foreground">点击上传参考图</p>
                                </div>
                            </div>
                        </div>

                        <!-- 提示词 -->
                        <div>
                            <label class="text-sm font-medium mb-2 block">提示词</label>
                            <textarea id="imagePrompt" rows="4" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm resize-y" placeholder="描述你想要生成的图片内容..."></textarea>
                        </div>

                        <!-- 生成按钮 -->
                        <button onclick="generateImage()" id="imageGenBtn" class="w-full inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 text-sm font-medium">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            开始生成
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧：预览区域 -->
            <div class="rounded-lg border border-border bg-background p-6">
                <h3 class="text-lg font-semibold mb-4">生成结果</h3>
                <div id="imageResult" class="space-y-4">
                    <div id="imagePreviewArea" class="aspect-square bg-muted rounded-lg flex items-center justify-center">
                        <p class="text-muted-foreground">等待生成...</p>
                    </div>
                    <div id="imageStatus" class="text-sm text-muted-foreground text-center"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast 通知 -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 hidden animate-slide-up">
        <div class="rounded-lg border bg-background px-4 py-3 shadow-lg">
            <p id="toastMessage" class="text-sm"></p>
        </div>
    </div>

    <script>
        // 状态变量
        let videoMode = 'normal';
        let videoOrientation = 'landscape';
        let videoDuration = '10';
        let imageSize = '1024x1024';
        let videoRefBase64 = null;
        let imageRefBase64 = null;
        let isGenerating = false;

        // 工具函数
        const $=id=>document.getElementById(id);
        
        function showToast(msg, type='info') {
            const toast = $('toast');
            const message = $('toastMessage');
            message.textContent = msg;
            message.className = 'text-sm ' + (type === 'error' ? 'text-destructive' : type === 'success' ? 'text-green-600' : '');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Tab 切换
        function switchTab(tab) {
            const tabs = ['video', 'image'];
            tabs.forEach(t => {
                const panel = $('panel' + t.charAt(0).toUpperCase() + t.slice(1));
                const tabBtn = $('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (t === tab) {
                    panel.classList.remove('hidden');
                    tabBtn.classList.add('border-primary');
                    tabBtn.classList.remove('border-transparent');
                } else {
                    panel.classList.add('hidden');
                    tabBtn.classList.remove('border-primary');
                    tabBtn.classList.add('border-transparent');
                }
            });
        }

        // 视频模式切换
        function setVideoMode(mode) {
            videoMode = mode;
            ['normal', 'remix', 'storyboard'].forEach(m => {
                const btn = $('mode' + m.charAt(0).toUpperCase() + m.slice(1));
                if (m === mode) {
                    btn.classList.add('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.remove('border-input');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.add('border-input');
                }
            });
            // 显示/隐藏 Remix ID 输入框
            $('remixIdSection').classList.toggle('hidden', mode !== 'remix');
        }

        // 画面比例切换
        function setOrientation(orient) {
            videoOrientation = orient;
            ['landscape', 'portrait'].forEach(o => {
                const btn = $('orient' + o.charAt(0).toUpperCase() + o.slice(1));
                if (o === orient) {
                    btn.classList.add('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.remove('border-input');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.add('border-input');
                }
            });
            // 更新预览区域比例
            const preview = $('videoPreviewArea');
            preview.classList.remove('aspect-video', 'aspect-portrait');
            preview.classList.add(orient === 'portrait' ? 'aspect-portrait' : 'aspect-video');
        }

        // 视频时长切换
        function setDuration(dur) {
            videoDuration = dur;
            ['10', '15', '25'].forEach(d => {
                const btn = $('dur' + d);
                if (d === dur) {
                    btn.classList.add('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.remove('border-input');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.add('border-input');
                }
            });
        }

        // 图片尺寸切换
        function setImageSize(size) {
            imageSize = size;
            const sizeMap = {'1024x1024': '1x1', '1792x1024': '3x2', '1024x1792': '2x3', '1536x1024': '16x9'};
            Object.keys(sizeMap).forEach(s => {
                const btn = $('size' + sizeMap[s].replace(':', 'x'));
                if (s === size) {
                    btn.classList.add('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.remove('border-input');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary', 'text-primary-foreground');
                    btn.classList.add('border-input');
                }
            });
            // 更新预览区域比例
            const preview = $('imagePreviewArea');
            preview.classList.remove('aspect-square', 'aspect-video', 'aspect-portrait');
            if (size === '1024x1024') preview.classList.add('aspect-square');
            else if (size === '1024x1792') preview.classList.add('aspect-portrait');
            else preview.classList.add('aspect-video');
        }

        // 视频参考图上传
        function handleVideoRefUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                videoRefBase64 = e.target.result.split(',')[1];
                $('videoRefImg').src = e.target.result;
                $('videoRefPreview').classList.remove('hidden');
                $('videoRefPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearVideoRef(event) {
            event.stopPropagation();
            videoRefBase64 = null;
            $('videoRefInput').value = '';
            $('videoRefPreview').classList.add('hidden');
            $('videoRefPlaceholder').classList.remove('hidden');
        }

        // 图片参考图上传
        function handleImageRefUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                imageRefBase64 = e.target.result.split(',')[1];
                $('imageRefImg').src = e.target.result;
                $('imageRefPreview').classList.remove('hidden');
                $('imageRefPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImageRef(event) {
            event.stopPropagation();
            imageRefBase64 = null;
            $('imageRefInput').value = '';
            $('imageRefPreview').classList.add('hidden');
            $('imageRefPlaceholder').classList.remove('hidden');
        }

        // 获取 API Key (从 localStorage 或提示输入)
        function getApiKey() {
            let apiKey = localStorage.getItem('test_api_key');
            if (!apiKey) {
                apiKey = prompt('请输入 API Key:');
                if (apiKey) localStorage.setItem('test_api_key', apiKey);
            }
            return apiKey;
        }

        // 生成视频
        async function generateVideo() {
            if (isGenerating) return;
            
            const prompt = $('videoPrompt').value.trim();
            if (!prompt) {
                showToast('请输入提示词', 'error');
                return;
            }

            const apiKey = getApiKey();
            if (!apiKey) {
                showToast('需要 API Key', 'error');
                return;
            }

            isGenerating = true;
            const btn = $('videoGenBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>生成中...';
            
            $('videoStatus').textContent = '正在生成视频，请稍候...';
            $('videoPreviewArea').innerHTML = '<div class="flex flex-col items-center justify-center h-full"><svg class="animate-spin h-8 w-8 text-primary mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-muted-foreground">生成中...</p></div>';

            try {
                const body = {
                    prompt: prompt,
                    seconds: videoDuration,
                    orientation: videoOrientation,
                    style_id: $('videoStyle').value || undefined
                };
                
                if (videoRefBase64) body.input_image = videoRefBase64;
                if (videoMode === 'remix') body.remix_target_id = $('remixTargetId').value.trim();

                const response = await fetch('/v1/videos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || '生成失败');
                }

                if (data.data && data.data[0] && data.data[0].url) {
                    const url = data.data[0].url;
                    $('videoPreviewArea').innerHTML = `<video src="${url}" controls class="w-full h-full rounded-lg object-contain" autoplay></video>`;
                    $('videoStatus').innerHTML = `<a href="${url}" target="_blank" class="text-primary hover:underline">下载视频</a>`;
                    showToast('视频生成成功！', 'success');
                } else {
                    throw new Error('未获取到视频URL');
                }
            } catch (e) {
                $('videoPreviewArea').innerHTML = '<p class="text-destructive">生成失败</p>';
                $('videoStatus').textContent = e.message;
                showToast('生成失败: ' + e.message, 'error');
            } finally {
                isGenerating = false;
                btn.disabled = false;
                btn.innerHTML = '<svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>开始生成';
            }
        }

        // 生成图片
        async function generateImage() {
            if (isGenerating) return;
            
            const prompt = $('imagePrompt').value.trim();
            if (!prompt) {
                showToast('请输入提示词', 'error');
                return;
            }

            const apiKey = getApiKey();
            if (!apiKey) {
                showToast('需要 API Key', 'error');
                return;
            }

            isGenerating = true;
            const btn = $('imageGenBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>生成中...';
            
            $('imageStatus').textContent = '正在生成图片，请稍候...';
            $('imagePreviewArea').innerHTML = '<div class="flex flex-col items-center justify-center h-full"><svg class="animate-spin h-8 w-8 text-primary mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-muted-foreground">生成中...</p></div>';

            try {
                const body = {
                    prompt: prompt,
                    size: imageSize
                };
                
                if (imageRefBase64) body.input_image = imageRefBase64;

                const response = await fetch('/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || '生成失败');
                }

                if (data.data && data.data[0] && data.data[0].url) {
                    const url = data.data[0].url;
                    $('imagePreviewArea').innerHTML = `<img src="${url}" class="w-full h-full rounded-lg object-contain" />`;
                    $('imageStatus').innerHTML = `<a href="${url}" target="_blank" class="text-primary hover:underline">下载图片</a>`;
                    showToast('图片生成成功！', 'success');
                } else {
                    throw new Error('未获取到图片URL');
                }
            } catch (e) {
                $('imagePreviewArea').innerHTML = '<p class="text-destructive">生成失败</p>';
                $('imageStatus').textContent = e.message;
                showToast('生成失败: ' + e.message, 'error');
            } finally {
                isGenerating = false;
                btn.disabled = false;
                btn.innerHTML = '<svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>开始生成';
            }
        }
    </script>
</body>
</html>
